---
export const prerender = true;

import Post from "../../layouts/Post.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  return posts.map((post) => {
    const d =
      post.data.publishDate instanceof Date
        ? post.data.publishDate
        : new Date(post.data.publishDate);

    const yyyy = String(d.getUTCFullYear());
    const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
    const dd = String(d.getUTCDate()).padStart(2, "0");

    return {
      // IMPORTANT: for [...path], use a STRING, not an array
      params: { path: `${yyyy}/${mm}/${dd}/${post.slug}` },
      props: { slug: post.slug },
    };
  });
}

const { slug } = Astro.props;

const posts = await getCollection("blog");
const post = posts.find((p) => p.slug === slug);

if (!post) {
  throw new Error(`Post not found: ${slug}`);
}

const { Content } = await post.render();
---

<Post frontmatter={post.data} slug={slug}>
  <Content />
</Post>
