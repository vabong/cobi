---
import Base from "./Base.astro";
import fs from "fs";
import path from "path";
import { getEntryBySlug } from "astro:content";

const { frontmatter, slug } = Astro.props;
const post = await getEntryBySlug("blog", slug);

// Always use post.slug as folder name
const folder = post.slug;

// ✅ Render markdown properly
const { Content } = await post.render();

// Load all images in the correct blog folder
let images: string[] = [];
const dir = path.resolve(`public/images/blog/${folder}`);

if (fs.existsSync(dir)) {
  images = fs
    .readdirSync(dir)
    .filter((f) => /\.(png|jpe?g|webp|gif)$/i.test(f))
    .sort();
}
---

<Base title={frontmatter.title}>
  <article class="post">
    <header>
      <h1>{frontmatter.title}</h1>
      {frontmatter.publishDate && (
        <p class="date">
          {new Date(frontmatter.publishDate).toLocaleDateString()}
        </p>
      )}
    </header>

    {images.length > 0 && (
      <div class="carousel-container">
        <button class="nav prev" onClick="scrollCarousel(-1)">‹</button>

        <div class="carousel" id="carousel">
          {images.map((img, i) => (
            <div class="slide">
              <img
                src={`/images/blog/${folder}/${img}`}
                alt={`image ${i + 1}`}
                loading="lazy"
              />
            </div>
          ))}
        </div>

        <button class="nav next" onClick="scrollCarousel(1)">›</button>
      </div>
    )}

    <section class="body">
      <Content />
    </section>

    {frontmatter.tags?.length > 0 && (
      <div class="tags">
        {frontmatter.tags.map((tag) => (
          <a href={`/tags/${tag.toLowerCase()}/`} class="tag">#{tag}</a>
        ))}
      </div>
    )}
  </article>

  <script is:inline>
    function scrollCarousel(direction) {
      const el = document.getElementById("carousel");
      if (!el) return;
      const width = el.clientWidth;
      el.scrollBy({ left: width * direction, behavior: "smooth" });
    }
  </script>

  <style>
    /* ... keep all your existing styles exactly as-is ... */
  </style>
</Base>
